<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>도근점 20개 표시 지도</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
// =======================
// 1) 브이월드 도근점 데이터 요청
// =======================
async function fetchDogeunData() {
    const apiKey = "7E3F2D01-5A0A-3513-8DC6-6E831632BDC4";  // 민도운님 브이월드 키

    const url = `https://api.vworld.kr/ned/data/dgprecise?service=DGPrePrecise&request=GetFeature&key=${apiKey}&format=json&size=20&page=1`;

    const response = await fetch(url);
    const json = await response.json();

    if (!json || !json.response || !json.response.result || !json.response.result.featureCollection)
        return [];

    return json.response.result.featureCollection.features;
}

// =======================
// 2) EPSG:5179 → WGS84 변환
// =======================
function convert5179ToWGS84(x, y) {
    const proj4_5179 = "+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=600000 +ellps=GRS80 +units=m +no_defs";
    const proj4_4326 = "+proj=longlat +datum=WGS84 +no_defs";

    const result = proj4(proj4_5179, proj4_4326, [x, y]);
    return { lng: result[0], lat: result[1] };
}

// =======================
// 3) 지도 초기화
// =======================
let map;
let markers = [];

function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.5, lng: 127.5 },
        zoom: 13,
        mapTypeId: "hybrid"
    });

    loadDogeunPoints();
}

// =======================
// 4) 도근점 표시
// =======================
async function loadDogeunPoints() {
    const data = await fetchDogeunData();

    // 빨간 동그라미 아이콘 (기존보다 2배 크게, 선명하게)
    const redcircle = {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: "#ff0000",
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeWeight: 2,
        scale: 12   // 기존 6 → 12 로 2배 확대
    };

    // 기존 마커 제거
    markers.forEach(m => m.setMap(null));
    markers = [];

    data.forEach(f => {
        const coords = f.geometry.coordinates; // EPSG5179 (x,y)
        const conv = convert5179ToWGS84(coords[0], coords[1]);

        const marker = new google.maps.Marker({
            position: conv,
            map: map,
            icon: redcircle
        });

        markers.push(marker);
    });
}

</script>

<!-- proj4 변환 라이브러리 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.6/proj4.js"></script>

<!-- Google 지도 JS API (민도운님 키 포함) -->
<script async
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9BIK9PhwIvEL5uzIlGtTh2iK8piDn2pw&callback=initMap">
</script>

</body>
</html>
