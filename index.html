<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë‚´ ì†ì•ˆì˜ ê¸°ì¤€ì  ì§€ë„</title>
    <style>
        /* 1. ì „ì²´ ë ˆì´ì•„ì›ƒ */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; background-color: #f0f0f0; }
        #map { width: 100%; height: 100%; }

        /* 2. ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ë””ìì¸ (ìš°ì¸¡ ìƒë‹¨) */
        .controls {
            position: absolute; top: 10px; right: 10px; z-index: 20;
            display: flex; flex-direction: column; gap: 8px;
        }
        .btn {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #aaa;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-align: left;
            display: flex; align-items: center; gap: 5px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn:active { background: #eee; transform: scale(0.98); }
        .btn-gps { color: #d32f2f; border-color: #d32f2f; }

        /* 3. ì¸í¬ìœˆë„ìš° ìŠ¤íƒ€ì¼ */
        .info-window {
            padding: 5px;
            font-size: 13px;
            width: 220px;
            line-height: 1.5;
            color: #333;
        }
        .info-title { font-weight: bold; color: #007bff; margin-bottom: 4px; display: block; border-bottom: 1px solid #ddd; padding-bottom: 2px;}
        .info-coord { color: #666; font-size: 11px; margin-top: 4px; display: block; }

        /* 4. ë¡œë”© ë° ìƒíƒœ ë©”ì‹œì§€ */
        #status-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; padding: 15px 20px;
            border-radius: 10px; z-index: 30; display: none; font-size: 14px;
        }
        #map-error {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #f8f9fa; z-index: 5; color: #666; text-align: center;
            display: none;
        }
    </style>
</head>
<body>

    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div id="status-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="map-error">
        <div>
            <h3>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h3>
            <p>API í‚¤ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë„ë©”ì¸ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <p>GitHub Pages ì£¼ì†Œë¥¼ ì¹´ì¹´ì˜¤ ê°œë°œì ì„¼í„°ì— ë“±ë¡í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <!-- ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>

    <!-- ë²„íŠ¼ ì»¨íŠ¸ë¡¤ (ìš”ì²­í•˜ì‹  4ê°œ ë²„íŠ¼) -->
    <div class="controls">
        <button class="btn btn-gps" onclick="moveToMyLocation()">ğŸ“ ë‚´ ìœ„ì¹˜</button>
        <button class="btn" onclick="loadVworldLayer('LSMD_CONT_LDREG', 'ì§€ì ë„ê·¼ì ')">ğŸ”² ì§€ì ë„ê·¼ì </button>
        <button class="btn" onclick="loadVworldLayer('N3A_G01100', 'ì‚¼ê°ì ')">ğŸ”º ì‚¼ê°ì </button>
        <button class="btn" onclick="loadVworldLayer('N3A_G01000', 'ì‚¼ê°ì ë³´ì¡°ì ')">ğŸ“ ì‚¼ê°ì ë³´ì¡°ì </button>
    </div>

    <!-- 
      [ì¤‘ìš”] ì¹´ì¹´ì˜¤ë§µ API í‚¤ ì„¤ì • 
      ì‚¬ìš©ìë‹˜ì´ ì œê³µí•´ì£¼ì‹  í‚¤ë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤.
    -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9eba96c379fe5ab109218d57c323eb3d"></script>
    
    <script>
        // ==========================================
        // 1. ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜
        // ==========================================
        const VWORLD_KEY = "E8FE02C6-643C-3EE7-84EE-CC7636083CCD"; 
        
        let map = null; 
        let markers = []; 
        let currentInfowindow = null; 
        let isMapLoaded = false; 

        // ==========================================
        // 2. ì§€ë„ ì´ˆê¸°í™”
        // ==========================================
        window.onload = function() {
            var container = document.getElementById('map');
            
            // ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨ ì²´í¬
            if (typeof kakao === 'undefined' || !kakao.maps) {
                document.getElementById('map-error').style.display = 'flex';
                return;
            }

            var options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), 
                level: 3 
            };

            try {
                map = new kakao.maps.Map(container, options);
                isMapLoaded = true; 
            } catch (e) {
                console.error("ì§€ë„ ìƒì„± ì‹¤íŒ¨:", e);
                document.getElementById('map-error').style.display = 'flex';
            }
        };

        // ==========================================
        // 3. JSONP í†µì‹  í•¨ìˆ˜
        // ==========================================
        function jsonpRequest(url, callbackName) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${url}&callback=${callbackName}`;
                script.async = true;

                window[callbackName] = function(data) {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    resolve(data);
                };

                script.onerror = function() {
                    document.body.removeChild(script);
                    delete window[callbackName];
                    reject(new Error("JSONP request failed"));
                };

                document.body.appendChild(script);
            });
        }

        // ==========================================
        // 4. V-World ë°ì´í„° ë¡œë“œ
        // ==========================================
        function loadVworldLayer(layerName, title) {
            // [ì•ˆì „ì¥ì¹˜] ì§€ë„ê°€ ì—†ìœ¼ë©´ ì‹¤í–‰ ì¤‘ë‹¨ (ì˜¤ë¥˜ ë°©ì§€)
            if (!isMapLoaded || !map) {
                alert("ì§€ë„ê°€ ë¡œë“œë˜ì§€ ì•Šì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì¹´ì¹´ì˜¤ ê°œë°œì ì„¼í„°ì— ë„ë©”ì¸(GitHubì£¼ì†Œ)ì„ ë“±ë¡í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                return;
            }

            showLoading(true, title + " ì¡°íšŒ ì¤‘...");
            removeMarkers();

            var bounds = map.getBounds();
            var sw = bounds.getSouthWest();
            var ne = bounds.getNorthEast();
            var bbox = `${sw.getLng()},${sw.getLat()},${ne.getLng()},${ne.getLat()}`;
            
            var callbackName = 'vworld_cb_' + Date.now();
            // size=100: í™”ë©´ ë‚´ ìµœëŒ€ 100ê°œê¹Œì§€ ê°€ì ¸ì˜´
            var url = `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=${layerName}&key=${VWORLD_KEY}&bbox=${bbox}&crs=EPSG:4326&size=100&format=jsonp`;

            jsonpRequest(url, callbackName)
                .then(data => {
                    showLoading(false);
                    if (data.response.status !== "OK") {
                        // ë°ì´í„° ì—†ìŒ ë“± API ì‘ë‹µì´ OKê°€ ì•„ë‹ ë•Œ
                        alert("í˜„ì¬ í™”ë©´ ë‚´ì— " + title + " ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    var features = data.response.result.featureCollection.features;
                    
                    // ê±°ë¦¬ìˆœ ì •ë ¬
                    var center = map.getCenter();
                    features.forEach(f => {
                        var fLat = f.geometry.coordinates[1];
                        var fLng = f.geometry.coordinates[0];
                        f.distance = Math.pow(fLat - center.getLat(), 2) + Math.pow(fLng - center.getLng(), 2);
                    });
                    features.sort((a, b) => a.distance - b.distance);
                    
                    // ìƒìœ„ 20ê°œë§Œ ìë¥´ê¸°
                    var top20 = features.slice(0, 20);

                    if(top20.length === 0) {
                        alert("í˜„ì¬ í™”ë©´ ë‚´ì— " + title + " ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    top20.forEach(feat => createMarker(feat, title));
                    
                    // ì™„ë£Œ ë©”ì‹œì§€ (ì„ íƒ ì‚¬í•­)
                    // alert(top20.length + "ê°œì˜ " + title + "ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.");
                })
                .catch(error => {
                    showLoading(false);
                    console.error(error);
                    alert("ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë‚˜ V-World í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                });
        }

        // ==========================================
        // 5. ë§ˆì»¤ ìƒì„± ë° ìœ í‹¸
        // ==========================================
        function createMarker(feature, typeTitle) {
            var coords = feature.geometry.coordinates; 
            var props = feature.properties;
            var position = new kakao.maps.LatLng(coords[1], coords[0]);

            var marker = new kakao.maps.Marker({
                position: position,
                map: map
            });

            kakao.maps.event.addListener(marker, 'click', function() {
                if (currentInfowindow) currentInfowindow.close();

                var name = props.kor_nm || props.bldg_nm || props.pnt_nm || typeTitle;
                var addr = props.addr || props.road_nm || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";
                var pnu = props.pnu || "-";
                
                var content = `
                    <div class="info-window">
                        <span class="info-title">${typeTitle}: ${name}</span>
                        <div><b>ì£¼ì†Œ:</b> ${addr}</div>
                        <div><b>ì½”ë“œ:</b> ${props.pnt_cd || props.manage_no || '-'}</div>
                        <span class="info-coord">
                            <b>X:</b> ${coords[0].toFixed(5)}, <b>Y:</b> ${coords[1].toFixed(5)}
                        </span>
                    </div>
                `;

                var infowindow = new kakao.maps.InfoWindow({
                    content: content,
                    removable: true
                });

                infowindow.open(map, marker);
                currentInfowindow = infowindow;
            });

            markers.push(marker);
        }

        function removeMarkers() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }

        function moveToMyLocation() {
            if (!isMapLoaded || !map) {
                alert("ì§€ë„ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            if (navigator.geolocation) {
                showLoading(true, "ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...");
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        showLoading(false);
                        var lat = position.coords.latitude;
                        var lon = position.coords.longitude;
                        var locPosition = new kakao.maps.LatLng(lat, lon);
                        map.setCenter(locPosition);
                        
                        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
                        // removeMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ìœ ì§€ ì—¬ë¶€ì— ë”°ë¼ ì£¼ì„ ì²˜ë¦¬
                        var marker = new kakao.maps.Marker({ map: map, position: locPosition });
                        var iwContent = '<div style="padding:5px; color:red; font-weight:bold;">ğŸ“ ë‚´ ìœ„ì¹˜</div>';
                        var infowindow = new kakao.maps.InfoWindow({ content : iwContent, removable : true });
                        infowindow.open(map, marker);
                    }, 
                    function(error) {
                        showLoading(false);
                        alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("ì´ ê¸°ê¸°ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        function showLoading(show, msg) {
            var el = document.getElementById('status-msg');
            if (show) {
                el.innerText = msg || "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }
    </script>
</body>
</html>
