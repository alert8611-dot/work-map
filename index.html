<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>도근점 20개 표시 지도</title>
    <style>
        #map {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9BIK9PhwIvEL5uzIlGtTh2iK8piDn2pw"></script>

    <div id="map"></div>

    <script>
        const VWORLD_KEY = "7E3F201-5A0A-3513-8DC6-6E831632BDC4";

        let map;
        let markers = [];

        function initMap() {
            const center = { lat: 36.4800, lng: 127.2890 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: center,
                mapTypeId: "hybrid"
            });

            loadGeogung(center);

            google.maps.event.addListener(map, "idle", function () {
                const c = map.getCenter();
                loadGeogung({ lat: c.lat(), lng: c.lng() });
            });
        }

        function loadGeogung(center) {
            const url = `
                https://api.vworld.kr/req/wfs?
                key=${VWORLD_KEY}
                &service=WFS
                &request=GetFeature
                &version=2.0.0
                &typeNames=lp_pa_cbnd
                &count=20
                &srsName=EPSG:5179
                &bbox=${center.lng - 500},${center.lat - 500},
                      ${center.lng + 500},${center.lat + 500},
                      EPSG:5179
            `.replace(/\s+/g, "");

            fetch(url)
                .then(res => res.json())
                .then(json => {

                    if (!json.response || !json.response.result)
                        return;

                    const features = json.response.result.featureCollection.features;

                    markers.forEach(m => m.setMap(null));
                    markers = [];

                    features.forEach(f => {
                        if (!f.geometry || !f.geometry.coordinates)
                            return;

                        const [x, y] = f.geometry.coordinates;

                        // EPSG:5179 → EPSG:4326 변환(중부원점)
                        const conv = convert5179ToWgs84(x, y);

                        const marker = new google.maps.Marker({
                            position: conv,
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                fillColor: "red",
                                fillOpacity: 1,
                                strokeColor: "white",
                                strokeWeight: 1,
                                scale: 6
                            }
                        });

                        markers.push(marker);
                    });

                })
                .catch(err => console.error(err));
        }

        // EPSG:5179 → WGS84 변환 공식
        function convert5179ToWgs84(x, y) {
            const proj4Str5179 = "+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=600000 +ellps=GRS80 +units=m +no_defs";
            const proj4Str4326 = "+proj=longlat +datum=WGS84 +no_defs";

            // 직접 구현 (proj4 없이 변환)
            const dx = x - 200000;
            const dy = y - 600000;

            const lon = 127 + dx / (6378137 * Math.cos(38 * Math.PI/180));
            const lat = 38 + dy / 6378137;

            return { lat: lat, lng: lon };
        }

        window.onload = initMap;
    </script>

</body>
</html>
