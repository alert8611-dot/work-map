<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>도근점 조회 지도</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; }
    </style>
</head>

<body>
<div id="map"></div>

<script>
// ===== 구글맵 초기 설정 =====
function initMap() {
    const start = { lat: 36.4801, lng: 127.2890 };

    window.map = new google.maps.Map(document.getElementById("map"), {
        center: start,
        zoom: 16,
        mapTypeId: google.maps.MapTypeId.SATELLITE,
        gestureHandling: "greedy",
    });

    // 줌/이동이 끝나면 도근점 다시 로드
    map.addListener("idle", () => {
        loadVworldData();
    });

    loadVworldData();
}



// ===== 브이월드 도근점 불러오기 =====
function loadVworldData() {
    const bounds = map.getBounds();
    if (!bounds) return;

    const sw = bounds.getSouthWest();
    const ne = bounds.getNorthEast();

    // 구글맵 좌표(WGS84)를 브이월드용 EPSG:3857로 변환
    const sw3857 = lonLatTo3857(sw.lng(), sw.lat());
    const ne3857 = lonLatTo3857(ne.lng(), ne.lat());

    const bbox = `${sw3857.x},${sw3857.y},${ne3857.x},${ne3857.y}`;

    const apiKey = "7E3F2D01-5A0A-3513-8DC6-6E831632BDC4";

    const url = `https://api.vworld.kr/req/data?service=data` +
                `&key=${apiKey}` +
                `&request=GetFeature&data=LT_LM_CP_FC` +
                `&format=application/json&size=20` +
                `&bbox=${bbox}`;

    fetch(url)
        .then(r => r.json())
        .then(json => {
            if (!json.response || !json.response.result) return;

            clearMarkers();
            const list = json.response.result.featureCollection.features;

            list.forEach(f => {
                const g = f.geometry;
                if (!g) return;

                let coord;
                if (g.type === "Point") coord = g.coordinates;
                else if (g.type === "MultiPoint") coord = g.coordinates[0];
                else return;

                const conv = epsg3857ToWgs84(coord[0], coord[1]);
                addMarker(conv);
            });
        })
        .catch(err => console.error(err));
}



// ====== EPSG 변환 ======
function lonLatTo3857(lon, lat) {
    const R = 6378137;
    const x = R * (lon * Math.PI / 180);
    const y = R * Math.log(Math.tan(Math.PI / 4 + lat * Math.PI / 360));
    return { x, y };
}

function epsg3857ToWgs84(x, y) {
    const lon = (x / 6378137) * 180 / Math.PI;
    const lat = (Math.atan(Math.exp(y / 6378137)) - Math.PI / 4) * 360 / Math.PI;
    return { lat, lng: lon };
}



// ===== Marker 관리 =====
let markers = [];

function addMarker(pos) {
    const m = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: "red",
            fillOpacity: 1,
            scale: 6,
            strokeWeight: 1,
            strokeColor: "white"
        }
    });
    markers.push(m);
}

function clearMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
}
</script>

<!-- ===== 구글맵 API 로드 ===== -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9BIK9PhwIvEL5uzIlGtTh2iK8piDn2pw&callback=initMap" async defer></script>

</body>
</html>
